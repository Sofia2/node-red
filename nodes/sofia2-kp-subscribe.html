<html>
     <div style="display: none;" id="dialog-error" title="Se ha producido un error">Se ha perdido la comunicación con la plataforma</div>  

	<script type="text/javascript" language="javascript" src="config/sofia2-config.js"></script>
	<script type="text/javascript">
		
        RED.nodes.registerType('sofia2-kp-subscribe',{
			category: 'input',
			color: '#C0DEED',
			defaults: {
                name: {value:""},
				        ontology:{value:""},
                token : {value:""},
                thinKp : {value:""},
				        instanciakp: {value:""},
                query : {value:""},
                tipoQuery:{value:""},
                msRefresh:{value:""},
                pingQuery:{value:""},
                pingType:{value:""},
                pingTimer:{value:""}

				
			},
			inputs: 0,
			outputs:1,
			icon: "input.png",
			label: function() {
				return this.name||"sofia2-kp-subscribe";
			}
        });

      function showErrorDialogSub() {
            $( "#dialog-error" ).dialog({
              resizable: false,
              modal: true,
              position: [($(window).width() / 2) - 150, 160],
              dialogClass: 'DeleteConfirmDialog',
               buttons: {
                    'OK': function () {
                        $(this).dialog("close");
                        return true;
                    }
                }
            });
          }


     var listaOntologiasUsuario;
     var insertedLista = false;
     var listaKpUsuario;
     var insertedListaKp = false;
    

     

     function onElementInserted(containerSelector, elementSelector, callback) {

            var onMutationsObserved = function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        var elements = $(mutation.addedNodes).find(elementSelector);
                        for (var i = 0, len = elements.length; i < len; i++) {
                            callback(elements[i]);
                        }
                    }
                });
            };

            var target = $(containerSelector)[0];
            var config = { childList: true, subtree: true };
            var MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
            var observer = new MutationObserver(onMutationsObserved);    
            observer.observe(target, config);

    }

     function getParameterByName(name, url) {
            if (!url) {
              url = window.location.href;
            }
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }


     var user = getParameterByName('usuario');
    var password = getParameterByName('password');
     

     function obtenerDataUsuario(user){


 

             var urlService = sofia2Config.scriptBasePath +'/script/services/api_motorflujo/v01/dataAllUser?user=';

             var url = urlService+user+"&password=" + password;


             $.ajax({
                url:    url , 
                dataType: "jsonp",
                timeout:5000,
                jsonpCallback: 'dataAllUser',
               success: function(data, textStatus, jqXHR) {
                    
                    if(textStatus == "success"){
                       
                       
                       listaOntologiasUsuario = data.toString().split("##$$##")[0];
                       listaOntologiasUsuario = listaOntologiasUsuario.split(",");
                       listaOntologiasUsuario.splice(listaOntologiasUsuario.length-1, listaOntologiasUsuario.length);
                       listaKpUsuario = data.toString().split("##$$##")[1];
                       listaKpUsuario = listaKpUsuario.split(",");
                       listaKpUsuario.splice(0,1);

               onElementInserted('body', '#node-input-ontologySub', function(element) {
                 while(insertedLista == false){ 
                  $('#node-input-ontologySub').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaOntologiasUsuario, function (i, item) {
                                    $('#node-input-ontologySub').append('<option value='+item+'>'+item+'</option>');
                                });
                        
                      insertedLista = true; 
                  }

                  if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
                                         $('#node-input-ontologySub').val( $('#node-input-ontology').val());
                                      }
                  $('#node-input-ontologySub').change(function(){
                      $('input[name=selectOntologySub]').val( $('#node-input-ontologySub').val());
                      
                      if($('#node-input-ontology').val() !=  $('#node-input-ontologySub').val()){
                          $('#node-input-ontology').val($('#node-input-ontologySub').val());   
                      }
                      


                    }); 
              });   


        

            onElementInserted('body', '#node-input-thinKpSub', function(element) {
                 while(insertedListaKp == false){ 
                   $('#node-input-thinKpSub').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaKpUsuario, function (i, item) {
                                    $('#node-input-thinKpSub').append('<option value='+item+'>'+item+'</option>');
                                });
                        
                      insertedListaKp = true; 
                  }
                     if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
                     $('#node-input-thinKpSub').val( $('#node-input-thinKp').val());
                     }  

                  $('#node-input-thinKpSub').change(function(){

                      $('input[name=selectThinKpSub]').val( $('#node-input-thinKpSub').val());

                      if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSub').val()){
                                $('#node-input-thinKp').val($('#node-input-thinKpSub').val());   
                            }
                                
                   });
              }); 
 

                       

                          

                        } 
                    

             }  
              , error: function(xhr, status, error) {
                 
                    
                 if(listaOntologiasUsuario!=null && listaKpUsuario!=null){

                      
                   onElementInserted('body', '#node-input-ontologySub', function(element) {
                     while(insertedLista == false){ 
                      $('#node-input-ontologySub').append('<option value='+""+'>'+""+'</option>');
                            $.each(listaOntologiasUsuario, function (i, item) {
                                        $('#node-input-ontologySub').append('<option value='+item+'>'+item+'</option>');
                                    });
                            
                          insertedLista = true; 
                      }

                      if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
                                             $('#node-input-ontologySub').val( $('#node-input-ontology').val());
                                          }
                      $('#node-input-ontologySub').change(function(){
                          $('input[name=selectOntologySub]').val( $('#node-input-ontologySub').val());
                          
                          if($('#node-input-ontology').val() !=  $('#node-input-ontologySub').val()){
                              $('#node-input-ontology').val($('#node-input-ontologySub').val());   
                          }
                          


                        }); 
                  });   


        

                  onElementInserted('body', '#node-input-thinKpSub', function(element) {
                       while(insertedListaKp == false){ 
                         $('#node-input-thinKpSub').append('<option value='+""+'>'+""+'</option>');
                              $.each(listaKpUsuario, function (i, item) {
                                          $('#node-input-thinKpSub').append('<option value='+item+'>'+item+'</option>');
                                      });
                              
                            insertedListaKp = true; 
                        }
                           if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
                           $('#node-input-thinKpSub').val( $('#node-input-thinKp').val());
                           }  

                        $('#node-input-thinKpSub').change(function(){

                            $('input[name=selectThinKpSub]').val( $('#node-input-thinKpSub').val());

                            if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSub').val()){
                                      $('#node-input-thinKp').val($('#node-input-thinKpSub').val());   
                                  }
                                      
                         });
                    }); 
 

                    }else{
                      showErrorDialogSub();
                    }
              }  
              
              
            })

       }


      //llamada a obtener los datos del usuario.
      obtenerDataUsuario(getParameterByName('usuario')); 



  
  

	</script>

	<script type="text/x-red" data-template-name="sofia2-kp-subscribe">
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
		<div class="form-row">
			<label for="node-input-ontologySub"><i class="icon-th-list"></i>Ontologies available</label>
            <select id="node-input-ontologySub" placeholder="Ontologies available">
                
            </select>
			
		</div>

     <div class="form-row">
      <label for="node-input-ontology"><i class="icon-tag"></i> Ontology</label>
      <input  disabled="disabled" type="text" id="node-input-ontology" placeholder="Ontology">
    </div>


		<div class="form-row">
			<label for="node-input-kp"><i class=" icon-bookmark"></i>Token</label>
			<input type="text" id="node-input-token" placeholder="Token">
		</div>

    <div class="form-row">
        <label for="node-input-thinKpSub"><i class="icon-th-list"></i>ThinKP available</label>
        <select id="node-input-thinKpSub" placeholder="ThinKP available">
            
        </select>
    </div>

    <div class="form-row">
      <label for="node-input-thinKp"><i class="icon-tag"></i> ThinKP</label>
      <input  disabled="disabled" type="text" id="node-input-thinKp" placeholder="ThinKP">
    </div>

		<div class="form-row">
			<label for="node-input-instanciakp"><i class="icon-file"></i>KP instance</label>

			<input type="text" id="node-input-instanciakp" placeholder="KP instance">
		</div>
        <div class="form-row">
            <label for="node-input-query"><i class="icon-file"></i>Query</label>
            <input type="text" id="node-input-query" placeholder="Query">
        </div>
        

        <div class="form-row">
            <label for="node-input-tipoQuery"><i class="icon-th-list"></i> Query type</label>
            <select id="node-input-tipoQuery" placeholder="Query type">
                <option value="NATIVE"> NATIVE</option>
                <option value="SQLLIKE"> SQLLIKE</option>
                
            </select>
        </div>

        <div class="form-row">
            <label for="node-input-msRefresh"><i class="icon-file"></i>msRefresh</label>
            <input type="text" id="node-input-msRefresh" placeholder="msRefresh">
        </div>
        
        <div class="form-row">
            <label for="node-input-pingQuery"><i class="icon-file"></i> Ping query</label>
             <input type="text" id="node-input-pingQuery" placeholder="Ping query">
        </div>
        
        <div class="form-row">
            <label for="node-input-pingType"><i class="icon-th-list"></i> Ping type</label>
            <select id="node-input-pingType" placeholder="Ping type">
                <option value="NATIVE"> NATIVE</option>
                <option value="SQLLIKE"> SQLLIKE</option>
                
            </select>
        </div> 
 
        <div class="form-row">
            <label for="node-input-pingTimer"><i class="icon-file"></i> Ping timer</label>
            <select id="node-input-pingTimer" placeholder="Ping timer">
                <option value="5000"> 5sg</option>
                <option value="30000"> 30sg</option>
                <option value="60000"> 1min</option>
                <option value="300000"> 5min</option>
                <option value="900000"> 15min</option>
                <option value="1800000"> 30min</option>
                <option value="3600000"> 1h</option>


                
            </select> 
           
        </div>
		
         <input type="hidden" name="selectOntologySub" value="">
         <input type="hidden" name="selectThinKpSub" value="">
    
       <script type="text/javascript">

             var insertedLista = false;
             var insertedListaKp = false;
  


            onElementInserted('body', '#node-input-ontologySub', function(element) {
                 while(insertedLista == false){ 
                  $('#node-input-ontologySub').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaOntologiasUsuario, function (i, item) {
                                    $('#node-input-ontologySub').append('<option value='+item+'>'+item+'</option>');
                                });
                        
                      insertedLista = true; 
                  }

                  if( $('#node-input-ontology').val()!=null &&  $('#node-input-ontology').val()!=""){
                                         $('#node-input-ontologySub').val( $('#node-input-ontology').val());
                                      }
                  $('#node-input-ontologySub').change(function(){
                      $('input[name=selectOntologySub]').val( $('#node-input-ontologySub').val());
                      
                      if($('#node-input-ontology').val() !=  $('#node-input-ontologySub').val()){
                          $('#node-input-ontology').val($('#node-input-ontologySub').val());   
                      }
                      


                    }); 
              });   


        

            onElementInserted('body', '#node-input-thinKpSub', function(element) {
                 while(insertedListaKp == false){ 
                   $('#node-input-thinKpSub').append('<option value='+""+'>'+""+'</option>');
                        $.each(listaKpUsuario, function (i, item) {
                                    $('#node-input-thinKpSub').append('<option value='+item+'>'+item+'</option>');
                                });
                        
                      insertedListaKp = true; 
                  }
                     if( $('#node-input-thinKp').val()!=null &&  $('#node-input-thinKp').val()!=""){
                     $('#node-input-thinKpSub').val( $('#node-input-thinKp').val());
                     }  

                  $('#node-input-thinKpSub').change(function(){

                      $('input[name=selectThinKpSub]').val( $('#node-input-thinKpSub').val());

                      if($('#node-input-thinKp').val() !=  $('#node-input-thinKpSub').val()){
                                $('#node-input-thinKp').val($('#node-input-thinKpSub').val());   
                            }
                                
                   });
              }); 
 

         </script>

	</script>



	<script type="text/x-red" data-help-name="sofia2-kp-subscribe">
		<p>SOFIA2-KP-SUBSCRIBE offers a flow, allowing the flow IoT trigger all of Sofia 2</p>
        <p><code>Ontology</code> It is used to identity the node SSAP by a specific ontology. 
        This is an optional field.</p>
        <p><code>ThinKp</code>It is used to indicate the  ThinKP.</p>
        <p><code>KP instance</code>It is used to indicate the  KP instance to be referenced.</p>
        <p><code>Token</code>It is used to indicate the  Token to be referenced.</p>  
        <p><code>Query</code>Contains an sql or native statement of mongoDB.</p>
        <p><code>Query type</code>Select the type of query.</p>
        <p><code>msRefresh</code>It is used to indicate the msRefresh</p>
        <p><code>Ping query</code>Contains an sql.</p>
        <p><code>Ping type</code>Select the type of query.</p>
        <p><code>Ping timer</code>Is run periodically, to check if the connection is established.</p>

	</script>
</html>
